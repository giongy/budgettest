    def recalc_category(self, cid: int):
        # guard to avoid treating auto-calculated cells as user edits
        if self._recalc_guard:
            return
        self._recalc_guard = True
        try:
            # Find category row
            root = self.model.invisibleRootItem()
            target = None
            depth = 0
            for r in range(root.rowCount()):
                cat_item = root.child(r, 0)
                if not cat_item:
                    continue
                meta = cat_item.data(Qt.ItemDataRole.UserRole)
                if meta and meta[0] == "category_label" and meta[1] == cid:
                    target = cat_item
                    depth = meta[2] or 0
                    break
        if target is None:
            self._recalc_guard = False
            return

        header_ids = getattr(self, "header_ids", [])
        actual_map = getattr(self, "actual_map", {})
        base_budget_map = getattr(self, "base_budget_map", {})
        if not header_ids:
            self._recalc_guard = False
            return

        year_bid = header_ids[0]
        # Discover row indices
        budget_row_idx = diff_row_idx = actual_row_idx = None
        for rr in range(target.rowCount()):
            label = target.child(rr, 0).text() if target.child(rr, 0) else ""
            if label == "Budget":
                budget_row_idx = rr
            elif label == "Diff":
                diff_row_idx = rr
            elif label == "Actual":
                actual_row_idx = rr
        if budget_row_idx is None or diff_row_idx is None:
            self._recalc_guard = False
            return

        # Read UI period cell (source of truth after edits)
        period_cell = target.child(budget_row_idx, 2)
        year_per = (period_cell.text() or "Monthly").strip()

        # Effective annual amount (edits override base)
        year_amt = None
        if (year_bid, cid) in self.edits and "amount" in self.edits[(year_bid, cid)]:
            year_amt = float(self.edits[(year_bid, cid)]["amount"])
        else:
            year_amt = base_budget_map.get((cid, year_bid), (0.0,))[0]

        # Explicit months map (edits override base)
        month_bids = list(header_ids[1:])
        explicit_month_sum = 0.0
        explicit_map = {}
        missing_bids = []
        for bid in month_bids:
            val = None
            if (bid, cid) in self.edits and "amount" in self.edits[(bid, cid)]:
                val = float(self.edits[(bid, cid)]["amount"])
            else:
                base = base_budget_map.get((cid, bid), (None,))[0]
                val = base
            if val is None:
                missing_bids.append(bid)
            else:
                explicit_map[bid] = val
                explicit_month_sum += float(val)

        # Re-render Budget row cells
        total_bud = 0.0
        monthly_value_for_diff = {}
        if year_per == "Yearly" and missing_bids:
            residual = (year_amt or 0.0) - explicit_month_sum
            per_missing = residual / float(len(missing_bids)) if missing_bids else 0.0
            for idx, bid in enumerate(month_bids, start=3):
                disp = explicit_map.get(bid, per_missing)
                monthly_value_for_diff[bid] = disp
                total_bud += disp
                item = target.child(budget_row_idx, idx)
                if item:
                    item.setText(f"{disp:,.2f}")
                    # color: blue explicit, gray calculated
                    item.setForeground(QBrush(QColor("#01579b") if bid in explicit_map else QColor("#6b7280")))
        else:
            missing_count = 0
            for idx, bid in enumerate(month_bids, start=3):
                amt = explicit_map.get(bid)
                item = target.child(budget_row_idx, idx)
                if amt is None:
                    missing_count += 1
                    monthly_value_for_diff[bid] = 0.0
                    if item:
                        item.setText("")
                        item.setForeground(QBrush(QColor("#01579b")))
                else:
                    monthly_value_for_diff[bid] = amt
                    total_bud += amt
                    if item:
                        item.setText(f"{amt:,.2f}")
                        item.setForeground(QBrush(QColor("#01579b")))
            if year_amt:
                if year_per == "Yearly":
                    total_bud += (year_amt / 12.0) * missing_count
                elif year_per == "Weekly":
                    total_bud += (year_amt * 52.0 / 12.0) * missing_count
                else:
                    total_bud += year_amt * missing_count

        # Update total cell and color
        tot_col = 3 + len(month_bids)
        tot_item = target.child(budget_row_idx, tot_col)
        if tot_item:
            tot_item.setText(f"{total_bud:,.2f}")
            if year_amt and abs(explicit_month_sum) > abs(year_amt):
                tot_item.setBackground(QBrush(QColor("#F8D6D6")))
            else:
                # reset to default based on depth shading
                if depth == 0:
                    tot_item.setBackground(QBrush(QColor("#f0f0f0")))
                else:
                    tot_item.setBackground(QBrush())

        # Recompute Diff row
        # Year diff
        year_act = actual_map.get((cid, year_bid), 0.0)
        year_bud = year_amt or 0.0
        year_diff = year_act - year_bud
        year_cell = target.child(diff_row_idx, 1)
        if year_cell:
            year_cell.setText(f"{year_diff:,.2f}" if year_diff else "")
            year_cell.setFont(QFont("Segoe UI", 10, italic=True))
            year_cell.setBackground(
                QBrush(QColor("#D1F0D1") if year_diff > 0 else QColor("#F8D6D6") if year_diff < 0 else QColor("#EEE"))
            )
        # monthly diffs
        total_diff = 0.0
        for idx, bid in enumerate(month_bids, start=3):
            a = actual_map.get((cid, bid), 0.0)
            b = monthly_value_for_diff.get(bid, 0.0) if year_per == "Yearly" else base_budget_map.get((cid, bid), (0.0,))[0] or 0.0
            d = a - b
            total_diff += d
            cell = target.child(diff_row_idx, idx)
            if cell:
                cell.setText(f"{d:,.2f}" if d else "")
                cell.setFont(QFont("Segoe UI", 10, italic=True))
                cell.setBackground(
                    QBrush(QColor("#D1F0D1") if d > 0 else QColor("#F8D6D6") if d < 0 else QColor("#EEE"))
                )
        tot_diff_cell = target.child(diff_row_idx, tot_col)
        if tot_diff_cell:
            tot_diff_cell.setText(f"{total_diff:,.2f}")
            tot_diff_cell.setFont(QFont("Segoe UI", 10, italic=True))
            tot_diff_cell.setBackground(
                QBrush(QColor("#D1F0D1") if total_diff > 0 else QColor("#F8D6D6") if total_diff < 0 else QColor("#EEE"))
            )
        finally:
            self._recalc_guard = False

